<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Reserva tu mesa en JP restaurant">
    <meta name="author" content="Devcrud">
    <link rel="icon" type="image/jpg" href="{{ url_for('static', filename='assets/imgs/faviconImagen.jpg') }}">
    <title>Reservas - JP restaurant</title>
    <!-- font icons -->
    <link rel="stylesheet" href="{{ url_for('static', filename='assets/vendors/themify-icons/css/themify-icons.css')}}">
    <!-- Bootstrap + Pigga main styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/pigga.css')}}">
</head>
<body data-spy="scroll" data-target=".navbar" data-offset="40" id="home">
    
    <!-- Second Navigation -->
    <nav class="nav-second navbar custom-navbar navbar-expand-sm navbar-dark bg-dark sticky-top">
        <div class="container">
            <button class="navbar-toggler ml-auto" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav mr-auto"> 
                    <li class="nav-item">
                        <a class="nav-link" href="/">Inicio</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-primary">Contactanos : <span class="pl-2 text-muted">(57) 305 500 55 60</span></a>
                    </li>   
                </ul> 
            </div>
        </div>
    </nav>
    <!-- End Of Second Navigation --> 

    <section id="book-table" class="bg-white has-img-bg">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6 d-none d-md-block">
                    <img src="{{ url_for('static', filename='assets/imgs/contact.jpg')}}" class="w-100 rounded shadow">
                </div>
                <div class="col-md-6">
                    <h3 class="section-title mb-4">Reserva tu mesa</h3>
                    <form id="reservaForm">
                        <div class="form-group">
                            <input type="text" class="form-control" id="name" name="name" placeholder="Tu nombre" required>
                        </div>
                        <div class="form-group">
                            <input type="tel" class="form-control" name="phone" placeholder="Tu teléfono" required>
                        </div>
                        <div class="form-group">
                            <input type="date" class="form-control" name="fecha" id="fecha" required>
                            <script>
                                // Establecer la fecha mínima como hoy
                                const fechaInput = document.getElementById('fecha');
                                const hoy = new Date();
                                const yyyy = hoy.getFullYear();
                                const mm = String(hoy.getMonth() + 1).padStart(2, '0');
                                const dd = String(hoy.getDate()).padStart(2, '0');
                                const fechaMinima = `${yyyy}-${mm}-${dd}`;
                                fechaInput.min = fechaMinima;

                                // Si hay una fecha anterior a hoy seleccionada, la resetea
                                fechaInput.addEventListener('input', function() {
                                    if (this.value < fechaMinima) {
                                        this.value = fechaMinima;
                                    }
                                });
                            </script>
                        </div>
                        <div class="form-group">
                            <select class="form-control" name="hora" required>
                                <option value="" disabled selected>Hora</option>
                                <option value="07:00">7:00 AM</option>
                                <option value="07:30">7:30 AM</option>
                                <option value="08:00">8:00 AM</option>
                                <option value="08:30">8:30 AM</option>
                                <option value="09:00">9:00 AM</option>
                                <option value="09:30">9:30 AM</option>
                                <option value="10:00">10:00 AM</option>
                                <option value="10:30">10:30 AM</option>
                                <option value="11:00">11:00 AM</option>
                                <option value="11:30">11:30 AM</option>
                                <option value="12:00">12:00 PM</option>
                                <option value="12:00">12:30 PM</option>
                                <option value="12:00">1:00 PM</option>
                                <option value="12:00">1:30 PM</option>
                                <option value="12:00">2:00 PM</option>
                                <option value="12:00">2:30 PM</option>
                                <option value="12:00">3:00 PM</option>
                                <option value="12:00">3:30 PM</option>
                                <option value="12:00">4:00 PM</option>
                                <option value="12:00">4:30 PM</option>
                                <option value="12:00">5:00 PM</option>
                                <option value="12:00">5:30 PM</option>
                                <option value="12:00">6:00 PM</option>
                                <option value="12:00">6:30 PM</option>
                                <option value="12:00">7:00 PM</option>
                                <option value="12:00">7:30 PM</option>
                                <option value="12:00">8:00 PM</option>
                                <option value="12:00">8:30 PM</option>
                            </select>
                        </div>
                        <style>
                            select.form-control {
                                background-color: #fff !important;
                                color: #495057 !important;
                            }
                            select.form-control option {
                                background-color: #fff !important;
                                color: #495057 !important;
                            }
                            select.form-control option:first-child {
                                color: #6c757d !important;
                            }
                            #platosSection {
                                display: none;
                            }
                            #platosSection.show {
                                display: block;
                            }
                        </style>
                        <div class="form-group">
                            <input type="number" class="form-control" name="num_personas" placeholder="Número de personas" required>
                        </div>
                        
                        <div class="form-group">
                            <button type="button" class="btn btn-info btn-block mb-3" onclick="mostrarModalPlatos()">¿Deseas agregar platos a tu reserva?</button>
                        </div>

                        <button type="submit" class="btn btn-primary btn-block">Reservar una mesa</button>
                        <div id="mensajeReserva" class="alert mt-3" style="display: none;"></div>
                        <small class="form-text text-muted mt-3">No compartimos información sobre nuestros clientes. Consulta nuestra <a href="#">Política de privacidad</a></small>
                    </form>

                    <!-- Ventana de confirmación superpuesta -->
                    <div id="ventanaConfirmacion" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                        background: #1a1a1a; color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.5); 
                        z-index: 1000; width: 90%; max-width: 500px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h5 style="margin: 0; color: white;">Confirma tu reserva</h5>
                            <button onclick="cerrarVentana()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: white;">&times;</button>
                        </div>
                        
                        <div class="detalles-reserva">
                            <h6 style="color: white;">Detalles de la reserva:</h6>
                            <div id="detallesReserva" class="mb-3" style="color: #ffffff;">
                                <!-- Los detalles se insertarán aquí -->
                            </div>
                            
                            <div id="platosSeleccionados">
                                <h6 style="color: white;">Platos seleccionados:</h6>
                                <ul id="listaPlatosSeleccionados" class="list-unstyled" style="color: #ffffff;"></ul>
                                <p class="font-weight-bold" style="color: white;">Total: <span id="totalPedido"></span></p>
                            </div>
                        </div>

                        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                            <button class="btn btn-danger" onclick="cerrarVentana()">Cancelar</button>
                            <button class="btn btn-primary" onclick="confirmarReserva()">Confirmar</button>
                        </div>
                    </div>

                    <!-- Fondo oscuro -->
                    <div id="overlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
                        background: rgba(0,0,0,0.7); z-index: 999;"></div>

                </div>
            </div>
        </div>
    </section>

    <div class="modal fade" id="reservaExitosaModal" tabindex="-1" aria-labelledby="reservaExitosaLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content text-center">
            <div class="modal-header">
              <h5 class="modal-title w-100" id="reservaExitosaLabel">Reserva realizada</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
              <p class="mb-0">¡Reserva realizada con éxito!</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Aceptar</button>
            </div>
          </div>
        </div>
      </div>

    <!-- Page Footer -->
    <footer class="border border-dark border-left-0 border-right-0 border-bottom-0 p-4 bg-dark">
        <div class="container">
            <div class="row align-items-center text-center text-md-left">
                <div class="footer-text">
                    <p class="mb-0 small">&copy; <script>document.write(new Date().getFullYear())</script>, Jean Paul All rights reserved</p>
                </div>
            </div>
        </div>
    </footer>
    <!-- End of Page Footer -->

    <!-- core  -->
    <script src="{{ url_for('static', filename='assets/vendors/jquery/jquery-3.4.1.js')}}"></script>
    <script src="{{ url_for('static', filename='assets/vendors/bootstrap/bootstrap.bundle.js')}}"></script>

    <!-- bootstrap affix -->
    <script src="{{ url_for('static', filename='assets/vendors/bootstrap/bootstrap.affix.js')}}"></script>

    <!-- Pigga js -->
    <script src="{{ url_for('static', filename='assets/js/pigga.js')}}"></script>

    <!-- Categorías js -->
    <script src="{{ url_for('static', filename='assets/js/categorias.js')}}"></script>

    <!-- Modal de Selección de Platos -->
    <div id="modalPlatos" class="modal fade" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Selecciona tus platos</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <style>
                        .nav-categoria {
                            margin-bottom: 20px;
                            border-bottom: 1px solid #dee2e6;
                        }
                        .nav-categoria .nav-link {
                            color: #495057;
                            border: none;
                            border-bottom: 2px solid transparent;
                            padding: 10px 20px;
                            font-weight: 500;
                            background: none;
                            transition: all 0.3s ease;
                        }
                        .nav-categoria .nav-link:hover {
                            color: #007bff;
                        }
                        .nav-categoria .nav-link.active {
                            color: #007bff;
                            border-bottom: 2px solid #007bff;
                        }
                        .categoria-content {
                            display: none;
                        }
                        .categoria-content.active {
                            display: block;
                        }
                        .plato-item {
                            padding: 15px;
                            border-bottom: 1px solid rgba(0,0,0,0.1);
                            margin-bottom: 15px;
                        }
                        .plato-item:last-child {
                            border-bottom: none;
                            margin-bottom: 0;
                        }
                        .plato-imagen {
                            width: 120px;
                            min-width: 120px;
                            height: 120px;
                            object-fit: cover;
                            border-radius: 8px;
                            margin-right: 20px;
                        }
                        .plato-info {
                            flex-grow: 1;
                            padding-right: 15px;
                        }
                        .plato-info h5 {
                            margin-bottom: 10px;
                            color: #333;
                            font-weight: 600;
                            display: flex;
                            align-items: center;
                            gap: 10px;
                        }
                        .tipo-badge {
                            font-size: 0.7em;
                            padding: 3px 8px;
                            border-radius: 12px;
                            font-weight: 500;
                            text-transform: capitalize;
                            background-color: #e9ecef;
                            color: #495057;
                        }
                        .tipo-entrada {
                            background-color: #e3f2fd;
                            color: #1976d2;
                        }
                        .tipo-plato_fuerte {
                            background-color: #fbe9e7;
                            color: #d84315;
                        }
                        .tipo-postre {
                            background-color: #f3e5f5;
                            color: #7b1fa2;
                        }
                        .tipo-bebida {
                            background-color: #e8f5e9;
                            color: #2e7d32;
                        }
                        .plato-info .descripcion {
                            color: #666;
                            margin-bottom: 10px;
                            font-size: 0.9rem;
                        }
                        .plato-info .precio {
                            font-weight: bold;
                            font-size: 1.1rem;
                            margin-bottom: 0;
                        }
                        .plato-cantidad {
                            width: 80px;
                            text-align: center;
                        }
                    </style>
                    <ul class="nav nav-categoria" id="categoriasTabs">
                        <li class="nav-item">
                            <button class="nav-link active" data-categoria="entrada">Entradas</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-categoria="plato_fuerte">Platos Fuertes</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-categoria="postre">Postres</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-categoria="bebida">Bebidas</button>
                        </li>
                    </ul>

                    <div id="platosContainer">
                        {% for categoria in ['entrada', 'plato_fuerte', 'postre', 'bebida'] %}
                        <div class="categoria-content {% if categoria == 'entrada' %}active{% endif %}" data-categoria="{{ categoria }}">
                            <div class="platos-lista">
                                {% for plato in platos %}
                                    {% if plato.tipo_alimento == categoria %}
                                    <div class="plato-item">
                                        <div class="d-flex align-items-start">
                                            {% if plato.url_imagen %}
                                            <img src="{{ url_for('static', filename=plato.url_imagen) }}" 
                                                 alt="{{ plato.nombre }}" 
                                                 class="plato-imagen">
                                            {% endif %}
                                            <div class="plato-info">
                                                <h5>
                                                    {{ plato.nombre }}
                                                    <span class="tipo-badge tipo-{{ plato.tipo_alimento }}">
                                                        {% if plato.tipo_alimento == 'plato_fuerte' %}
                                                            Plato fuerte
                                                        {% else %}
                                                            {{ plato.tipo_alimento }}
                                                        {% endif %}
                                                    </span>
                                                </h5>
                                                <p class="descripcion">{{ plato.descripcion }}</p>
                                                <p class="precio text-primary">COP {{ "{:,.0f}".format(plato.precio) }}</p>
                                            </div>
                                            <div>
                                                <input type="number" min="0" value="0" 
                                                       class="form-control plato-cantidad" 
                                                       data-id="{{ plato.id }}"
                                                       data-nombre="{{ plato.nombre }}" 
                                                       data-precio="{{ plato.precio }}">
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="continuarReserva()">Continuar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function mostrarModalPlatos() {
            $('#modalPlatos').modal('show');
        }

        function continuarReserva() {
            const formData = new FormData(document.getElementById('reservaForm'));
            const platosSeleccionados = obtenerPlatosSeleccionados();
            
            if (platosSeleccionados.length === 0) {
                if (!confirm('¿Deseas continuar sin agregar platos a tu reserva?')) {
                    return;
                }
            }
            
            $('#modalPlatos').modal('hide');
            mostrarModal(formData);
        }

        function obtenerPlatosSeleccionados() {
            const platos = [];
            document.querySelectorAll('.plato-cantidad').forEach(input => {
                if (input.value > 0) {
                    platos.push({
                        id: parseInt(input.dataset.id), // ID del plato en la base de datos
                        cantidad: parseInt(input.value),
                        precio: parseInt(input.dataset.precio),
                        total: parseInt(input.value) * parseInt(input.dataset.precio)
                    });
                }
            });
            return platos;
        }

        function mostrarModal(formData) {
            const platos = obtenerPlatosSeleccionados();
            let totalPedido = 0;

            // Mostrar detalles de la reserva
            const detallesHtml = `
                <p><strong>Nombre:</strong> ${formData.get('name')}</p>
                <p><strong>Teléfono:</strong> ${formData.get('phone')}</p>
                <p><strong>Fecha:</strong> ${formData.get('fecha')}</p>
                <p><strong>Hora:</strong> ${formData.get('hora')}</p>
                <p><strong>Personas:</strong> ${formData.get('num_personas')}</p>
            `;
            document.getElementById('detallesReserva').innerHTML = detallesHtml;

            // Mostrar platos seleccionados
            const listaPlatos = document.getElementById('listaPlatosSeleccionados');
            listaPlatos.innerHTML = '';
            
            platos.forEach(plato => {
                const input = document.querySelector(`.plato-cantidad[data-id="${plato.id}"]`);
                const nombre = input.dataset.nombre;
                const total = plato.cantidad * plato.precio;
                totalPedido += total;
                
                const li = document.createElement('li');
                li.textContent = `${nombre} x${plato.cantidad} - COP ${total.toLocaleString()}`;
                listaPlatos.appendChild(li);
            });

            document.getElementById('totalPedido').textContent = `COP ${totalPedido.toLocaleString()}`;
            
            // Mostrar la ventana y el overlay
            document.getElementById('ventanaConfirmacion').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        }

        function cerrarVentana() {
            document.getElementById('ventanaConfirmacion').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }

        document.getElementById('reservaForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            mostrarModalPlatos();
        });

        document.getElementById('reservaExitosaModal').addEventListener('hidden.bs.modal', function () {
            window.location.href = '/clientes';
        });

        async function confirmarReserva() {
            const formData = new FormData(document.getElementById('reservaForm'));
            const platos = obtenerPlatosSeleccionados();
            
            const data = {
                fecha: formData.get('fecha'),
                hora: formData.get('hora'),
                num_personas: parseInt(formData.get('num_personas')),
                platos: platos
            };

            try {
                const response = await fetch('/api/reservas', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                const mensajeDiv = document.getElementById('mensajeReserva');
                
                if (response.ok) {
                    mensajeDiv.className = 'alert alert-success mt-3';
                    mensajeDiv.textContent = '¡Reserva realizada con éxito!';
                    cerrarVentana();

                    const modal = new bootstrap.Modal(document.getElementById('reservaExitosaModal'));
                    modal.show();

                    document.getElementById('btnAceptar').onclick = window.location.href = "{{ url_for('clientes') }}";;
                    // Cuando haga clic en el overlay (fuera del modal)
                    document.getElementById('overlay').onclick = window.location.href = "{{ url_for('clientes') }}";;

                } else {
                    mensajeDiv.className = 'alert alert-danger mt-3';
                    mensajeDiv.textContent = result.error || 'Error al realizar la reserva';
                }
                mensajeDiv.style.display = 'block';
            } catch (error) {
                console.error('Error:', error);
                const mensajeDiv = document.getElementById('mensajeReserva');
                mensajeDiv.className = 'alert alert-danger mt-3';
                mensajeDiv.textContent = 'Error al conectar con el servidor';
                mensajeDiv.style.display = 'block';
            }
        }
    </script>

</body>
</html>